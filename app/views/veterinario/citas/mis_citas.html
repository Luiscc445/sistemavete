{% extends "layouts/veterinario_base.html" %}
{% block title %}Mis Citas - RamboPet{% endblock %}

{% block content %}
<!-- Modern Page Header -->
<div class="vet-page-header vet-animate-fade-in">
    <div class="vet-page-header-content">
        <div class="vet-page-header-icon">
            <i class="bi bi-calendar-heart"></i>
        </div>
        <div class="vet-page-header-text">
            <h1 class="vet-page-header-title">Mis Citas</h1>
            <p class="vet-page-header-subtitle">Gestión de consultas médicas y atención a pacientes</p>
        </div>
    </div>
    <div class="vet-page-header-right">
        <div class="vet-page-header-badge">
            <i class="bi bi-calendar-check"></i>
            <span>{{ citas|length }} citas en total</span>
        </div>
        <div class="vet-page-header-date">
            <div class="vet-page-header-date-main">
                <i class="bi bi-clock"></i>
                <span id="headerTime">--:--</span>
            </div>
            <div class="vet-page-header-date-sub" id="headerDate">Cargando...</div>
        </div>
    </div>
</div>
<script>
(function(){
    const now = new Date();
    document.getElementById('headerTime').textContent = now.toLocaleTimeString('es-BO', {hour:'2-digit', minute:'2-digit'});
    document.getElementById('headerDate').textContent = now.toLocaleDateString('es-BO', {weekday:'long', day:'numeric', month:'long'});
})();
</script>
<!-- Stats Overview -->
<div class="citas-stats-row vet-animate-fade-in">
    {% set pendientes = citas|selectattr('estado', 'equalto', 'pendiente')|list|length %}
    {% set confirmadas = citas|selectattr('estado', 'equalto', 'confirmada')|list|length %}
    {% set completadas = citas|selectattr('estado', 'equalto', 'completada')|list|length + citas|selectattr('estado', 'equalto', 'atendida')|list|length %}
    {% set en_progreso = citas|selectattr('estado', 'equalto', 'en_progreso')|list|length %}
    
    <div class="citas-stat-card stat-pending">
        <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
        <div class="stat-info">
            <span class="stat-number">{{ pendientes }}</span>
            <span class="stat-label">Pendientes</span>
        </div>
    </div>
    <div class="citas-stat-card stat-confirmed">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-info">
            <span class="stat-number">{{ confirmadas }}</span>
            <span class="stat-label">Confirmadas</span>
        </div>
    </div>
    <div class="citas-stat-card stat-progress">
        <div class="stat-icon"><i class="bi bi-play-circle"></i></div>
        <div class="stat-info">
            <span class="stat-number">{{ en_progreso }}</span>
            <span class="stat-label">En Progreso</span>
        </div>
    </div>
    <div class="citas-stat-card stat-completed">
        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        <div class="stat-info">
            <span class="stat-number">{{ completadas }}</span>
            <span class="stat-label">Completadas</span>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row g-4">
    <!-- Main Column - Appointments -->
    <div class="col-xl-8 col-lg-7">
        <!-- Search & Filter Bar -->
        <div class="vet-card vet-mb-3 vet-animate-fade-in vet-stagger-1">
            <div class="vet-card-body">
                <form method="GET" action="{{ url_for('veterinario.mis_citas') }}" class="citas-filter-form">
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-4 col-md-6">
                            <div class="search-input-wrapper">
                                <i class="bi bi-search search-icon"></i>
                                <input type="text" class="vet-form-control search-input" 
                                       name="buscar" value="{{ buscar }}"
                                       placeholder="Buscar mascota o tutor...">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select class="vet-form-control" name="estado">
                                <option value="todos" {% if estado_filtro=='todos' %}selected{% endif %}>Todos</option>
                                <option value="pendiente" {% if estado_filtro=='pendiente' %}selected{% endif %}>Pendiente</option>
                                <option value="confirmada" {% if estado_filtro=='confirmada' %}selected{% endif %}>Confirmada</option>
                                <option value="en_progreso" {% if estado_filtro=='en_progreso' %}selected{% endif %}>En Progreso</option>
                                <option value="completada" {% if estado_filtro=='completada' %}selected{% endif %}>Completada</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-4">
                            <input type="date" class="vet-form-control" name="fecha_desde" value="{{ fecha_desde }}" placeholder="Desde">
                        </div>
                        <div class="col-lg-2 col-md-4">
                            <input type="date" class="vet-form-control" name="fecha_hasta" value="{{ fecha_hasta }}" placeholder="Hasta">
                        </div>
                        <div class="col-lg-2 col-md-4">
                            <div class="d-flex gap-2">
                                <button type="submit" class="vet-btn vet-btn-primary flex-grow-1">
                                    <i class="bi bi-funnel"></i>
                                </button>
                                <a href="{{ url_for('veterinario.mis_citas') }}" class="vet-btn vet-btn-secondary">
                                    <i class="bi bi-x-lg"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="citas-tabs vet-animate-fade-in vet-stagger-2">
            <button class="citas-tab active" data-filter="all">
                <i class="bi bi-grid-3x3-gap"></i>
                <span>Todas</span>
                <span class="tab-count">{{ citas|length }}</span>
            </button>
            <button class="citas-tab" data-filter="urgente">
                <i class="bi bi-exclamation-triangle"></i>
                <span>Hoy</span>
            </button>
            <button class="citas-tab" data-filter="pendiente">
                <i class="bi bi-hourglass-split"></i>
                <span>Pendientes</span>
            </button>
            <button class="citas-tab" data-filter="confirmada">
                <i class="bi bi-calendar-check"></i>
                <span>Confirmadas</span>
            </button>
        </div>

        <!-- Appointments List -->
        <div class="citas-list vet-animate-fade-in vet-stagger-3">
            {% if citas %}
                {% for c in citas %}
                <div class="cita-card {% if c.estado == 'completada' or c.estado == 'atendida' %}cita-completed{% endif %}" 
                     data-status="{{ c.estado }}"
                     data-date="{{ c.fecha.strftime('%Y-%m-%d') }}"
                     data-search="{{ c.mascota.nombre|lower }} {{ c.tutor.nombre_completo|lower if c.tutor else '' }}">
                    
                    <!-- Status Indicator -->
                    <div class="cita-status-bar 
                        {% if c.estado == 'completada' or c.estado == 'atendida' %}status-success
                        {% elif c.estado == 'cancelada' %}status-danger
                        {% elif c.estado == 'en_progreso' %}status-progress
                        {% elif c.estado == 'confirmada' %}status-info
                        {% else %}status-warning{% endif %}">
                    </div>
                    
                    <div class="cita-content">
                        <!-- Left Section - Pet Info -->
                        <div class="cita-pet-section">
                            <div class="cita-pet-avatar">
                                {% if c.mascota.foto_principal %}
                                <img src="{{ url_for('static', filename='uploads/pets/' + c.mascota.foto_principal) }}" alt="{{ c.mascota.nombre }}">
                                {% else %}
                                <div class="avatar-placeholder">
                                    {% if c.mascota.especie|lower == 'perro' %}
                                    <i class="bi bi-emoji-smile"></i>
                                    {% elif c.mascota.especie|lower == 'gato' %}
                                    <i class="bi bi-emoji-heart-eyes"></i>
                                    {% else %}
                                    <i class="bi bi-heart-pulse"></i>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="cita-pet-info">
                                <h4 class="pet-name">{{ c.mascota.nombre }}</h4>
                                <div class="pet-details">
                                    <span class="pet-species">
                                        <i class="bi bi-tag"></i> {{ c.mascota.especie }}
                                    </span>
                                    {% if c.mascota.raza %}
                                    <span class="pet-breed">{{ c.mascota.raza }}</span>
                                    {% endif %}
                                </div>
                                <div class="pet-tutor">
                                    <i class="bi bi-person"></i> {{ c.tutor.nombre_completo if c.tutor else 'N/A' }}
                                </div>
                            </div>
                        </div>

                        <!-- Center Section - Appointment Info -->
                        <div class="cita-info-section">
                            <div class="cita-datetime">
                                <div class="datetime-date">
                                    <i class="bi bi-calendar3"></i>
                                    <span>{{ c.fecha.strftime('%d %b %Y') }}</span>
                                </div>
                                <div class="datetime-time">
                                    <i class="bi bi-clock"></i>
                                    <span>{{ c.fecha.strftime('%H:%M') }}</span>
                                </div>
                            </div>
                            {% if c.motivo %}
                            <div class="cita-motivo">
                                <i class="bi bi-chat-left-text"></i>
                                <span>{{ c.motivo|truncate(50) }}</span>
                            </div>
                            {% endif %}
                            <div class="cita-badge-wrapper">
                                <span class="cita-status-badge 
                                    {% if c.estado == 'completada' or c.estado == 'atendida' %}badge-success
                                    {% elif c.estado == 'cancelada' %}badge-danger
                                    {% elif c.estado == 'en_progreso' %}badge-progress
                                    {% elif c.estado == 'confirmada' %}badge-info
                                    {% else %}badge-warning{% endif %}">
                                    <i class="bi 
                                        {% if c.estado == 'completada' or c.estado == 'atendida' %}bi-check-circle-fill
                                        {% elif c.estado == 'cancelada' %}bi-x-circle-fill
                                        {% elif c.estado == 'en_progreso' %}bi-play-fill
                                        {% elif c.estado == 'confirmada' %}bi-calendar-check-fill
                                        {% else %}bi-hourglass{% endif %}"></i>
                                    {{ c.estado|replace('_', ' ')|title }}
                                </span>
                            </div>
                        </div>

                        <!-- Right Section - Actions -->
                        <div class="cita-actions-section">
                            {% if c.estado in ['confirmada', 'pendiente', 'en_progreso'] %}
                            <a href="{{ url_for('veterinario.atender_cita', id=c.id) }}" class="cita-action-btn action-primary">
                                <i class="bi bi-stethoscope"></i>
                                <span>Atender</span>
                            </a>
                            {% elif c.estado in ['completada', 'atendida'] %}
                            <a href="{{ url_for('veterinario.ver_cita', id=c.id) }}" class="cita-action-btn action-secondary">
                                <i class="bi bi-eye"></i>
                                <span>Ver</span>
                            </a>
                            <a href="{{ url_for('veterinario.descargar_receta', id=c.id) }}" class="cita-action-btn action-download" title="Descargar PDF">
                                <i class="bi bi-file-pdf"></i>
                                <span>PDF</span>
                            </a>
                            {% else %}
                            <a href="{{ url_for('veterinario.ver_cita', id=c.id) }}" class="cita-action-btn action-secondary">
                                <i class="bi bi-eye"></i>
                                <span>Ver</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="citas-empty">
                <div class="empty-illustration">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <h4>No hay citas</h4>
                <p>No se encontraron citas con los filtros aplicados.</p>
                <a href="{{ url_for('veterinario.mis_citas') }}" class="vet-btn vet-btn-secondary">
                    <i class="bi bi-arrow-clockwise me-2"></i>Limpiar filtros
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right Column - Calendar & Quick Info -->
    <div class="col-xl-4 col-lg-5">
        <!-- Mini Calendar -->
        <div class="vet-card vet-animate-fade-in vet-stagger-2 vet-mb-3">
            <div class="vet-card-header">
                <h3>
                    <i class="bi bi-calendar3"></i> 
                    <span id="calendarMonthYear">Calendario</span>
                </h3>
                <div class="calendar-nav">
                    <button class="cal-nav-btn" onclick="changeMonth(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="cal-nav-btn" onclick="changeMonth(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="vet-card-body">
                <div class="calendar-grid" id="miniCalendar"></div>
                
                <!-- Legend -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-dot dot-success"></span>
                        <span>Completada</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot dot-info"></span>
                        <span>Confirmada</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot dot-warning"></span>
                        <span>Pendiente</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot dot-today"></span>
                        <span>Hoy</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Appointments -->
        <div class="vet-card vet-animate-fade-in vet-stagger-3">
            <div class="vet-card-header">
                <h3><i class="bi bi-clock-history"></i> Citas de Hoy</h3>
            </div>
            <div class="vet-card-body vet-p-0">
                {% set today = 'now'|string|truncate(10, True, '') %}
                {% set citas_hoy = citas|selectattr('fecha')|list %}
                {% set has_today = false %}
                
                <div class="today-appointments">
                    {% for c in citas %}
                        {% if c.fecha.strftime('%Y-%m-%d') == today %}
                        {% set has_today = true %}
                        <div class="today-apt-item">
                            <div class="today-apt-time">
                                <span class="time">{{ c.fecha.strftime('%H:%M') }}</span>
                            </div>
                            <div class="today-apt-info">
                                <span class="apt-pet">{{ c.mascota.nombre }}</span>
                                <span class="apt-status 
                                    {% if c.estado == 'completada' %}text-success
                                    {% elif c.estado == 'confirmada' %}text-info
                                    {% else %}text-warning{% endif %}">
                                    {{ c.estado|title }}
                                </span>
                            </div>
                            {% if c.estado in ['confirmada', 'pendiente'] %}
                            <a href="{{ url_for('veterinario.atender_cita', id=c.id) }}" class="today-apt-action">
                                <i class="bi bi-arrow-right"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not has_today %}
                    <div class="no-today-apts">
                        <i class="bi bi-calendar-check"></i>
                        <p>No hay citas programadas para hoy</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ============================================
   Mis Citas - Modern Redesign
   ============================================ */

/* Stats Row */
.citas-stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.citas-stat-card {
    background: var(--vet-white);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid;
    transition: all var(--transition-fast);
}

.citas-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.citas-stat-card .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.citas-stat-card .stat-info {
    display: flex;
    flex-direction: column;
}

.citas-stat-card .stat-number {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1;
    color: var(--vet-dark);
}

.citas-stat-card .stat-label {
    font-size: 0.75rem;
    color: var(--vet-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Stat Card Variants */
.stat-pending {
    border-color: #F59E0B;
}
.stat-pending .stat-icon {
    background: rgba(245, 158, 11, 0.1);
    color: #F59E0B;
}

.stat-confirmed {
    border-color: #3B82F6;
}
.stat-confirmed .stat-icon {
    background: rgba(59, 130, 246, 0.1);
    color: #3B82F6;
}

.stat-progress {
    border-color: var(--vet-primary);
}
.stat-progress .stat-icon {
    background: rgba(139, 69, 19, 0.1);
    color: var(--vet-primary);
}

.stat-completed {
    border-color: #10B981;
}
.stat-completed .stat-icon {
    background: rgba(16, 185, 129, 0.1);
    color: #10B981;
}

/* Search Input */
.search-input-wrapper {
    position: relative;
}

.search-input-wrapper .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--vet-gray-400);
}

.search-input-wrapper .search-input {
    padding-left: 2.75rem;
}

/* Tabs */
.citas-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    background: var(--vet-white);
    padding: 0.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
}

.citas-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border: none;
    background: transparent;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--vet-gray-600);
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
}

.citas-tab:hover {
    background: var(--vet-gray-50);
    color: var(--vet-primary);
}

.citas-tab.active {
    background: var(--vet-primary);
    color: var(--vet-white);
}

.citas-tab .tab-count {
    background: rgba(255,255,255,0.2);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-full);
    font-size: 0.7rem;
}

.citas-tab.active .tab-count {
    background: rgba(255,255,255,0.3);
}

/* Citas List */
.citas-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

/* Cita Card */
.cita-card {
    background: var(--vet-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: all var(--transition-fast);
    display: flex;
}

.cita-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateX(4px);
}

.cita-card.cita-completed {
    opacity: 0.85;
}

.cita-card.cita-completed:hover {
    opacity: 1;
}

/* Status Bar */
.cita-status-bar {
    width: 5px;
    flex-shrink: 0;
}

.status-success { background: #10B981; }
.status-danger { background: #EF4444; }
.status-progress { background: var(--vet-primary); }
.status-info { background: #3B82F6; }
.status-warning { background: #F59E0B; }

/* Cita Content */
.cita-content {
    flex: 1;
    display: flex;
    align-items: center;
    padding: 1rem 1.25rem;
    gap: 1.5rem;
}

/* Pet Section */
.cita-pet-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    min-width: 200px;
}

.cita-pet-avatar {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    overflow: hidden;
    flex-shrink: 0;
}

.cita-pet-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.cita-pet-avatar .avatar-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--vet-primary) 0%, var(--vet-primary-light) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--vet-white);
}

.cita-pet-info {
    min-width: 0;
}

.cita-pet-info .pet-name {
    font-size: 1rem;
    font-weight: 700;
    color: var(--vet-dark);
    margin: 0 0 0.25rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.cita-pet-info .pet-details {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--vet-gray-500);
    margin-bottom: 0.25rem;
}

.cita-pet-info .pet-details i {
    color: var(--vet-primary);
}

.cita-pet-info .pet-tutor {
    font-size: 0.8rem;
    color: var(--vet-gray-500);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Info Section */
.cita-info-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.cita-datetime {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.datetime-date, .datetime-time {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: var(--vet-gray-700);
    font-weight: 500;
}

.datetime-date i, .datetime-time i {
    color: var(--vet-primary);
}

.cita-motivo {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8rem;
    color: var(--vet-gray-500);
}

.cita-motivo i {
    color: var(--vet-gray-400);
}

/* Status Badge */
.cita-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-success { background: rgba(16, 185, 129, 0.1); color: #10B981; }
.badge-danger { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
.badge-progress { background: rgba(139, 69, 19, 0.1); color: var(--vet-primary); }
.badge-info { background: rgba(59, 130, 246, 0.1); color: #3B82F6; }
.badge-warning { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }

/* Actions Section */
.cita-actions-section {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.cita-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    text-decoration: none;
    font-size: 0.7rem;
    font-weight: 600;
    transition: all var(--transition-fast);
    min-width: 60px;
}

.action-primary {
    background: linear-gradient(135deg, var(--vet-primary) 0%, var(--vet-primary-dark) 100%);
    color: var(--vet-white);
}

.action-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
    color: var(--vet-white);
}

.action-secondary {
    background: var(--vet-gray-100);
    color: var(--vet-gray-700);
}

.action-secondary:hover {
    background: var(--vet-gray-200);
    color: var(--vet-gray-800);
}

.action-download {
    background: rgba(239, 68, 68, 0.1);
    color: #EF4444;
}

.action-download:hover {
    background: #EF4444;
    color: var(--vet-white);
}

.cita-action-btn i {
    font-size: 1.125rem;
}

/* Empty State */
.citas-empty {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--vet-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
}

.citas-empty .empty-illustration {
    width: 100px;
    height: 100px;
    background: var(--vet-gray-100);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
}

.citas-empty .empty-illustration i {
    font-size: 3rem;
    color: var(--vet-gray-400);
}

.citas-empty h4 {
    color: var(--vet-gray-700);
    margin-bottom: 0.5rem;
}

.citas-empty p {
    color: var(--vet-gray-500);
    margin-bottom: 1.5rem;
}

/* Calendar */
.calendar-nav {
    display: flex;
    gap: 0.25rem;
}

.cal-nav-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--vet-gray-100);
    border-radius: var(--radius-sm);
    color: var(--vet-gray-600);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.cal-nav-btn:hover {
    background: var(--vet-primary);
    color: var(--vet-white);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 1rem;
}

.cal-header {
    text-align: center;
    padding: 0.5rem;
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--vet-gray-500);
    text-transform: uppercase;
}

.cal-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    background: var(--vet-white);
    border: 1px solid var(--vet-gray-100);
    font-weight: 500;
}

.cal-day:hover:not(.other-month) {
    background: var(--vet-gray-100);
    border-color: var(--vet-primary);
}

.cal-day.today {
    background: var(--vet-primary);
    color: var(--vet-white);
    border-color: var(--vet-primary);
    font-weight: 700;
}

.cal-day.has-appointments::after {
    content: '';
    position: absolute;
    bottom: 3px;
    width: 5px;
    height: 5px;
    background: var(--vet-gold);
    border-radius: 50%;
}

.cal-day.today.has-appointments::after {
    background: var(--vet-white);
}

.cal-day.other-month {
    opacity: 0.3;
    pointer-events: none;
}

/* Calendar Legend */
.calendar-legend {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--vet-gray-100);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--vet-gray-600);
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.dot-success { background: #10B981; }
.dot-info { background: #3B82F6; }
.dot-warning { background: #F59E0B; }
.dot-today { background: var(--vet-primary); }

/* Today's Appointments */
.today-appointments {
    max-height: 300px;
    overflow-y: auto;
}

.today-apt-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--vet-gray-100);
    transition: background var(--transition-fast);
}

.today-apt-item:last-child {
    border-bottom: none;
}

.today-apt-item:hover {
    background: var(--vet-gray-50);
}

.today-apt-time {
    text-align: center;
    padding: 0.5rem 0.75rem;
    background: var(--vet-primary);
    border-radius: var(--radius-sm);
}

.today-apt-time .time {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--vet-white);
}

.today-apt-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.today-apt-info .apt-pet {
    font-weight: 600;
    color: var(--vet-dark);
}

.today-apt-info .apt-status {
    font-size: 0.75rem;
}

.today-apt-action {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--vet-gray-100);
    border-radius: 50%;
    color: var(--vet-gray-600);
    text-decoration: none;
    transition: all var(--transition-fast);
}

.today-apt-action:hover {
    background: var(--vet-primary);
    color: var(--vet-white);
}

.no-today-apts {
    text-align: center;
    padding: 2rem;
    color: var(--vet-gray-500);
}

.no-today-apts i {
    font-size: 2rem;
    color: var(--vet-gray-300);
    margin-bottom: 0.5rem;
    display: block;
}

.no-today-apts p {
    margin: 0;
    font-size: 0.875rem;
}

/* Responsive */
@media (max-width: 1200px) {
    .citas-stats-row {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 991px) {
    .cita-content {
        flex-wrap: wrap;
    }
    
    .cita-pet-section {
        width: 100%;
        min-width: auto;
    }
    
    .cita-info-section {
        width: 100%;
    }
    
    .cita-actions-section {
        width: 100%;
        justify-content: flex-end;
        padding-top: 0.75rem;
        border-top: 1px solid var(--vet-gray-100);
        margin-top: 0.75rem;
    }
}

@media (max-width: 768px) {
    .citas-stats-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .citas-stat-card {
        padding: 1rem;
    }
    
    .citas-stat-card .stat-number {
        font-size: 1.5rem;
    }
    
    .citas-tabs {
        padding: 0.375rem;
    }
    
    .citas-tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .citas-tab span:not(.tab-count) {
        display: none;
    }
}

@media (max-width: 480px) {
    .citas-stats-row {
        grid-template-columns: 1fr 1fr;
    }
    
    .cita-action-btn {
        padding: 0.5rem;
        min-width: 50px;
    }
    
    .cita-action-btn span {
        display: none;
    }
}
</style>

<script>
// Calendar data from backend
const citasPorFecha = {{ citas_por_fecha|tojson }};
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// Generate mini calendar
function generateMiniCalendar() {
    const calendar = document.getElementById('miniCalendar');
    const monthYearLabel = document.getElementById('calendarMonthYear');
    
    const year = currentCalendarYear;
    const month = currentCalendarMonth;
    const now = new Date();
    
    const monthName = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    monthYearLabel.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
    
    calendar.innerHTML = '';
    
    // Headers
    const days = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
    days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'cal-header';
        header.textContent = day;
        calendar.appendChild(header);
    });
    
    // Days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startingDayOfWeek = firstDay.getDay();
    
    // Previous month days
    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = document.createElement('div');
        day.className = 'cal-day other-month';
        day.textContent = prevMonthDays - i;
        calendar.appendChild(day);
    }
    
    // Current month days
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const day = document.createElement('div');
        day.className = 'cal-day';
        day.textContent = i;
        
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        
        // Check if today
        if (i === now.getDate() && month === now.getMonth() && year === now.getFullYear()) {
            day.classList.add('today');
        }
        
        // Check if has appointments
        if (citasPorFecha[dateStr]) {
            day.classList.add('has-appointments');
            day.title = `${citasPorFecha[dateStr].length} cita(s)`;
        }
        
        // Click to filter by date
        day.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.searchParams.set('fecha_desde', dateStr);
            url.searchParams.set('fecha_hasta', dateStr);
            window.location.href = url.toString();
        });
        
        calendar.appendChild(day);
    }
}

function changeMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }
    generateMiniCalendar();
}

// Tab filtering
document.querySelectorAll('.citas-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.citas-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.dataset.filter;
        const cards = document.querySelectorAll('.cita-card');
        const today = new Date().toISOString().split('T')[0];
        
        cards.forEach(card => {
            const status = card.dataset.status;
            const date = card.dataset.date;
            
            if (filter === 'all') {
                card.style.display = '';
            } else if (filter === 'urgente') {
                card.style.display = date === today ? '' : 'none';
            } else {
                card.style.display = status === filter ? '' : 'none';
            }
        });
    });
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    generateMiniCalendar();
});
</script>
{% endblock %}
