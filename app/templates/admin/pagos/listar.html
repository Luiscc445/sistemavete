{% extends "base.html" %}
{% block title %}Lista de Pagos{% endblock %}

{% block page_title %}
    <i class="bi bi-list-ul me-2"></i> Todos los Pagos
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('pagos.dashboard') }}">Pagos</a></li>
    <li class="breadcrumb-item active">Lista</li>
</ol>
{% endblock %}

{% block content %}

<!-- Filtros y Búsqueda -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
        <i class="bi bi-funnel me-2"></i>
        <strong>Filtros de Búsqueda</strong>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('pagos.listar') }}" class="row g-3">
            <!-- Búsqueda -->
            <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text" class="form-control" name="buscar"
                       value="{{ buscar }}"
                       placeholder="Código, descripción, transacción...">
            </div>

            <!-- Estado -->
            <div class="col-md-3">
                <label class="form-label">Estado</label>
                <select class="form-select" name="estado">
                    <option value="">Todos</option>
                    <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="procesando" {% if estado == 'procesando' %}selected{% endif %}>Procesando</option>
                    <option value="completado" {% if estado == 'completado' %}selected{% endif %}>Completado</option>
                    <option value="fallido" {% if estado == 'fallido' %}selected{% endif %}>Fallido</option>
                    <option value="reembolsado" {% if estado == 'reembolsado' %}selected{% endif %}>Reembolsado</option>
                    <option value="cancelado" {% if estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
                </select>
            </div>

            <!-- Método de Pago -->
            <div class="col-md-3">
                <label class="form-label">Método de Pago</label>
                <select class="form-select" name="metodo">
                    <option value="">Todos</option>
                    <option value="efectivo" {% if metodo == 'efectivo' %}selected{% endif %}>Efectivo</option>
                    <option value="tarjeta_credito" {% if metodo == 'tarjeta_credito' %}selected{% endif %}>Tarjeta de Crédito</option>
                    <option value="tarjeta_debito" {% if metodo == 'tarjeta_debito' %}selected{% endif %}>Tarjeta de Débito</option>
                    <option value="transferencia_bancaria" {% if metodo == 'transferencia_bancaria' %}selected{% endif %}>Transferencia</option>
                    <option value="qr_simple" {% if metodo == 'qr_simple' %}selected{% endif %}>QR Simple</option>
                    <option value="qr_tigo_money" {% if metodo == 'qr_tigo_money' %}selected{% endif %}>Tigo Money QR</option>
                    <option value="qr_banco" {% if metodo == 'qr_banco' %}selected{% endif %}>QR Bancario</option>
                </select>
            </div>

            <!-- Botones -->
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i> Filtrar
                </button>
            </div>
        </form>

        {% if estado or metodo or buscar %}
        <div class="mt-3">
            <a href="{{ url_for('pagos.listar') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i> Limpiar Filtros
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Tabla de Pagos -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-table me-2"></i>
            <strong>Lista de Pagos</strong>
            <span class="badge bg-light text-dark ms-2">{{ pagos.total }} registros</span>
        </div>
        <a href="{{ url_for('pagos.crear') }}" class="btn btn-light btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Nuevo Pago
        </a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>Código</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Monto</th>
                        <th>Pagado</th>
                        <th>Método</th>
                        <th class="text-center">Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% if pagos.items %}
                        {% for pago in pagos.items %}
                        <tr>
                            <!-- Código -->
                            <td>
                                <strong class="text-primary">{{ pago.codigo_pago }}</strong>
                                {% if pago.cita_id %}
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-calendar-check me-1"></i>Cita #{{ pago.cita_id }}
                                </small>
                                {% endif %}
                            </td>

                            <!-- Fecha -->
                            <td>
                                <small>{{ pago.fecha_creacion.strftime('%d/%m/%Y') }}</small>
                                <br>
                                <small class="text-muted">{{ pago.fecha_creacion.strftime('%H:%M') }}</small>
                            </td>

                            <!-- Cliente -->
                            <td>
                                {{ pago.usuario.nombre_completo }}
                                {% if pago.requiere_factura %}
                                <br>
                                <small class="text-info">
                                    <i class="bi bi-file-earmark-text me-1"></i>Factura
                                </small>
                                {% endif %}
                            </td>

                            <!-- Monto -->
                            <td>
                                <strong class="text-success">{{ pago.monto|currency }}</strong>
                            </td>

                            <!-- Pagado -->
                            <td>
                                <span class="text-success">{{ pago.monto_pagado|currency }}</span>
                                {% if pago.saldo_pendiente > 0 %}
                                <br>
                                <small class="text-danger">
                                    Pendiente: {{ pago.saldo_pendiente|currency }}
                                </small>
                                {% endif %}
                            </td>

                            <!-- Método -->
                            <td>
                                <small class="badge bg-secondary">
                                    {{ pago.metodo_pago_label }}
                                </small>
                                {% if 'qr' in pago.metodo_pago %}
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-qr-code"></i>
                                </small>
                                {% endif %}
                            </td>

                            <!-- Estado -->
                            <td class="text-center">
                                <span class="badge bg-{{ pago.estado_badge_class }}">
                                    {{ pago.estado|title }}
                                </span>
                                {% if pago.esta_vencido %}
                                <br>
                                <small class="text-danger">
                                    <i class="bi bi-exclamation-triangle"></i> Vencido
                                </small>
                                {% endif %}
                            </td>

                            <!-- Acciones -->
                            <td>
                                <a href="{{ url_for('pagos.ver', pago_id=pago.id) }}"
                                   class="btn btn-sm btn-outline-primary"
                                   data-bs-toggle="tooltip"
                                   title="Ver Detalle">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No se encontraron pagos con los filtros aplicados
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    {% if pagos.pages > 1 %}
    <div class="card-footer">
        <nav aria-label="Paginación de pagos">
            <ul class="pagination justify-content-center mb-0">
                <!-- Primera Página -->
                <li class="page-item {% if not pagos.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('pagos.listar', page=1, estado=estado, metodo=metodo, buscar=buscar) }}">
                        <i class="bi bi-chevron-double-left"></i>
                    </a>
                </li>

                <!-- Anterior -->
                <li class="page-item {% if not pagos.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('pagos.listar', page=pagos.prev_num, estado=estado, metodo=metodo, buscar=buscar) if pagos.has_prev else '#' }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>

                <!-- Páginas -->
                {% for page_num in pagos.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagos.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('pagos.listar', page=page_num, estado=estado, metodo=metodo, buscar=buscar) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                <!-- Siguiente -->
                <li class="page-item {% if not pagos.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('pagos.listar', page=pagos.next_num, estado=estado, metodo=metodo, buscar=buscar) if pagos.has_next else '#' }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>

                <!-- Última Página -->
                <li class="page-item {% if not pagos.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('pagos.listar', page=pagos.pages, estado=estado, metodo=metodo, buscar=buscar) }}">
                        <i class="bi bi-chevron-double-right"></i>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="text-center text-muted small mt-2">
            Mostrando {{ pagos.items|length }} de {{ pagos.total }} pagos (Página {{ pagos.page }} de {{ pagos.pages }})
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// Activar tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
});
</script>
{% endblock %}
